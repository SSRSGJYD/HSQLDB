### HSQLDB的存储机制分析

软件62 周展平 2016013253

------

[TOC]

#### 一、三种表类型的表结构与单行数据在HSQLDB中的实现

##### 1.单行数据的实现

+ 单行数据相关的类图：

![](Row.png)

+ 持久化存储相关类图：

![](RowStore.png)

+ 插入记录的过程

  向table中插入一个记录时，需要调用org.hsqldb.Table类的insertSingleRow方法。其中通过org.hsqldb.persist.Logger.newStore方法，根据table的类型创建不同的org.hsqldb.persist.PersistentStore类的子类实例，之后调用org.hsqldb.persist.RowStoreAVL.getNewCachedObject方法创建了一个对应于一个记录(单行数据)的对象，不同的table类型创建不同类的实例。

+ memory table

  调用的是org.hsqldb.persist.RowStoreAVLMemory类的getNewCachedObject方法，创建的是一个org.hsqldb.RowAVL类的实例。

+ cache table

  调用的是org.hsqldb.persist.RowStoreAVLDisk类的getNewCachedObject方法，如果记录很大，会创建一个org.hsqldb.RowAVLDiskLarge类的实例，否则创建一个org.hsqldb.RowAVLDisk类的实例。

+ text table

  调用的是org.hsqldb.persist.RowStoreAVLDiskData类的getNewCachedObject方法，创建的是一个org.hsqldb.RowAVLDiskData类的实例。

##### 2. 表结构的实现

memory table与cache table类型的表结构对应的类都是org.hsqldb.Table类，text table则对应于org.hsqldb.Table类的子类org.hsqldb.TextTable类，其中的type属性表示了表的不同类型。在创建新表时，org.hsqldb.TableWorks类负责为Table类的实例增加索引，索引对应于org.hsqldb.index.Index类。之后，org.hsqldb.Database.schemaManager类调用addSchemaObject方法将新添加的索引信息保存。如果创建过程中没有异常，则org.hsqldb.Database.logger类调用writeOtherStatement方法写入日志。



#### 二、内外存数据交换的实现

HSQLDB将文件读写封装了起来，通过org.hsqldb.persist.Logger管理日志文件，通过org.hsqldb.scriptio包中的类管理.script文件的读写，通过org.hsqldb.rowio包中的各个类管理二进制格式与文本格式的文件读写。

org.hsqldb.persist.Cache类对应于缓存，其中对于缓存的替换操作则是通过org.hsqldb.persist.DataFileCache类或org.hsqldb.persist.TextCache类管理的。

cache table通过org.hsqldb.persist.DataFileCache类管理内存与外存的数据交换，其中的get方法负责提供当行数据，如果数据存在于内存中则直接找到并返回，否则需要借助getFromFile方法，调用readObject方法利用org.hsqldb.rowio包中接口RowInputInterface的方法，将一行数据从.data文件读入内存，然后返回。对于写回外存，调用org.hsqldb.persist.DataFileCache类的saveRowNoLock等方法，利用org.hsqldb.rowio包中接口RowOutputInterface的方法写入文件。

text table通过org.hsqldb.persist.TextCache类管理内存与外存的数据交换，这个类继承自org.hsqldb.persist.DataFileCache类，因此在功能上大致相同。



#### 三、添加主键约束的实现

添加主键约束需要利用org.hsqldb.TableWorks类的addPrimaryKey方法，如下：

```java
void addPrimaryKey(Constraint constraint) {

    checkModifyTable(true);

    if (table.hasPrimaryKey()) { // 检查是否已经存在主键
        throw Error.error(ErrorCode.X_42532);
    }

    database.schemaManager.checkSchemaObjectNotExists(
        constraint.getName()); // 检查要添加的主键名称是否已经存在

    Table tn = table.moveDefinition(session, table.tableType, null,
                                    constraint, null, -1, 0, emptySet,
                                    emptySet); // 新建一个表并添加主键约束

    moveData(table, tn, -1, 0); // 将数据迁移到新的表中
    // 更新表的信息
    table = tn;

    database.schemaManager.addSchemaObject(constraint);
    setNewTableInSchema(table);
    updateConstraints(table, emptySet);
    database.schemaManager.recompileDependentObjects(table);
}
```

其中，涉及到主键设定的是org.hsqldb.table.moveDefinition方法，该方法基于旧表创建了一个新表，依次添加原有的属性并设置不为主键，之后调用createPrimaryKey方法将新的主键属性添加进去并设置为主键。在createPrimaryKey方法中，最主要的任务是调用setPrimaryKey方法设置主键，同时调用getNewPrimaryIndex和addIndexStructure方法建立主键的索引。



#### 四、缓存的替换机制与容量维护

org.hsqldb.map.BaseHashMap是HSQLDB所有的哈希表的基础类，缓存类org.hsqldb.persist.Cache是它的一个子类。